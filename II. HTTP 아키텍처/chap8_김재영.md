# chap 8 (게이트웨이, 터널, 릴레이)

HTTP 가 통신 프로토콜의 대부분을 차지하지만 HTTP 외에 다른 프로토콜을 사용하는 애플리케이션도 많다. 이런 서로 다른 프로토콜을 사용하는 애플리케이션을 서로 통신할 수 있게 하기 위해 그 중간에 게이트웨이라는 다리를 둔다.

![Image.png](https://res.craft.do/user/full/8884c80f-6eec-6a29-2a03-049def967beb/doc/669D65B8-52FF-4571-A66C-144B89B1D56A/833F8C6D-A668-48E5-A87D-EAB4476ED340_2/cFMZ4Lz8Q9Ks8PEuyDGOKsEdOZf02AvX3x3o50LAXqEz/Image.png)

## 게이트웨이

- 게이트웨이는 요청을 받고 응답을 보내는 포털 같이 동작하는데, 동적인 콘텐츠 생성 및 데이터 베이스에 질의를 보낼 수 있다.
- 게이트웨이는 **HTTP 트래픽을 다른 프로토콜로 자동변환**하여, HTTP 클라이언트가 다른 프토콜을 알 필요 없이 서버에 접속할 수 있게 한다.

### 프로토콜 게이트웨이

- 브라우저에 명시적으로 게이트웨이를 설정하여 자연스럽게 트래픽이 게이트웨이를 거쳐 가게 하거나, 게이트웨이를 대리 서버(리버스 프락시)로 설정할 수 있다.

**HTTP/*: 서버 측 웹 게이트웨이**

- 서버 측 웹 게이트웨이는 클라이언트로부터 HTTP 요청이 원 서버 영역으로 들어오는 시점에 클라이언트 측의 HTTP 요청을 외래 프로토콜로 전달한다.

**HTTP/HTTPS: 서버 측 보안 게이트웨이**

- 기업 내부의 모든 웹 요청을 암호화함으로써 개인 정보 보호와 보안을 제공하는데 게이트웨이를 사용할 수 있다.
- 게이트웨이는 자동으로 사용자의 모든 세션을 암호화한다.

### 리소스 게이트웨이

- 게이트웨이의 일반적인 사용 방식이다.

**공용 게이트웨이 인터페이스(CGI)**

- 웹에서 동적인 HTML, 신용카드 처리, 데이터베이스 질의등에 사용된다.
- CGI 애플리케이션이 서버와 분리되면서 펄, Tcl, C, 다양한 셸 언어를 포함하여 수 많은 언어로 구현할 수 있게됨

**서버 확장 API**

- 확장 API는 프로그래머가 자신의 코드를 서버에 연결하거나 서버의 컴포넌트를 자신이 만든 것으로 교체할 수 있게 한다.

> 일반적인 서버 애플리케이션으로 보면 되는걸까?

## 터널

- HTTP 프로토콜을 지원하지 않는 애플리케이션에 HTTP 애플리케이션을 사용해 접근하는 방법
- 웹 터널을 사용하면 HTTP 커넥션을 통해서 HTTP가 아닌 트래픽을 전송할 수 있고, 다른 프로토콜을 HTTP 위에 올릴 수 있다.
- 웹 터널을 쓰는 일반적 이유는 HTTP 커넥션 안에 **HTTP가 아닌 트래픽을 얹기 위해서** 이다.
- 웹 터널을 사용하면 웹 트래픽만 허용하는 방화벽이 있더라도 HTTP가 아닌 트래픽을 전송할 수 있다.

### CONNECT 메소드

- 웹 터널은 HTTP의 **CONNECT 메소드**를 사용하여 커넥션을 맺는다.
- CONNECT 요청을 한 뒤, 연결되면 그 때부터 양방향으로 데이터를 주고 받는다

![Image.png](https://res.craft.do/user/full/8884c80f-6eec-6a29-2a03-049def967beb/doc/669D65B8-52FF-4571-A66C-144B89B1D56A/6D6653E3-1DED-4F3B-B0CA-E10256590808_2/6pSPhwnO2h3xLSnJfPGYAkfSx1lMauxXz1ps0uvnU9Yz/Image.png)

1. 클라이언트는 게이트웨이에 터널을 연결하려고 CONNECT 요청을 보냄
2. 클라이언트의 CONNECT 메서드는 TCP 커넥션을 위해 게이트웨이에 터널 연결을 요청
3. TCP 커넥션이 생성됨
4. TCP 커넥션이 맺어지면, 게이트웨이는 클라이언트에게 **HTTP 200 Connection Established** 응답 전송
5. 이 시점에 터널이 연결됨

### 데이터 터널링, 시간, 커넥션 관리

- 터널을 통해 전달되는 데이터는 게이트웨이에서 볼 수 없어서, 게이트웨이는 패킷의 순서나 흐름에 대한 어떠한 가정도 할 수 없다.
- 클라이언트는 성능을 높이기 위해 CONNECT 요청을 보낸 다음, 응답을 받기 전에 터널 데이터를 전송할 수 있다.
- 게이트웨이는 커넥션이 맺어지는 대로 헤더를 포함해서 읽어들인 모든 데이터를 서버에 전송해야 한다.
- 요청 후에 터널을 통해 데이터를 전송한 클라이언트는 인증요구나 200 외의 응답이 왔을 때 요청 데이터를 다시 보낼 준비가 되어있어야 한다.

### SSL 터널링

- 웹 터널의 본래 의도에 가깝다.
- 웹 터널은 원래 방화벽을 통해서 암호화된 SSL 트래픽을 전달하려고 개발되었다.
- SSL 트래픽을 그대로 던지면 프록시에서 막힌다. 암, 복호화가 제대로 이루어지지 않을 것
- 그래서 HTTP 메시지에 암호화된 날 데이터를 담고 일반 HTTP 채널을 통해 데이터를 전송한다.

### SSL 터널링 vs HTTPS 게이트웨이

- HTTPS 프로토콜(HTTP over SSL)은 원격 HTTPS 서버와 클라이언트 사이에 SSL 세션을 시작하는 게이트웨이를 두고 그 게이트웨이 서버가 클라이언트 측의 HTTPS 트랜젝션을 수행하는 방식이다.
- 응답은 프락시가 받아서 복호화하고 난 후, HTTP를 통해 클라이언트로 전송한다.
- 이 방식도 단점이 존재한다.
   - 클라이언트-게이트웨이 사이에는 보안이 적용되지 않은 일반 HTTP 커넥션이 맺어져 있음
   - 프락시가 인증을 담당하기에, 클라이언트는 원격 서버에 SSL 클라이언트 인증(X509 인증서 기반의 인증)을 할 수 없다.
   - 게이트웨이는 SSL을 완벽히 지원해야 한다.

