# chap 7 (캐시)

## 웹 캐시

웹 캐시란 자주 쓰이는 문서의 사본은 자동으로 보관하는 HTTP 장치를 말한다.

## 웹 캐시를 왜 쓰는가?

- 캐시는 불필요한 데이터 전송을 줄여서, 네트워크 요금으로 인한 비용을 줄여준다.
- 캐시는 네트워크 병목을 줄여준다. 대역폭을 늘리지 않고도 페이지를 빨리 불러올 수 있게 된다.
- 캐시는 원 서버에 대한 요청을 줄여준다. 서버는 부하를 줄일 수 있으며 더 빨리 응답할 수 있게 된다.
- 페이지를 먼 곳에서 불러올수록 시간이 많이 걸리는데, 캐시는 거리로 인한 지연을 줄여준다.

### 불필요한 데이터 전송

- 복수의 클라이언트가 자주 쓰이는 원 서버 페이지에 접근할 때, 서버는 동일한 문서를 클라이언트들에게 각각 한 번씩 전송한다.
- 이 불필요한 데이터는 네트워크 대역폭을 잡아먹고, 전송을 느리게 만들며, 웹 서버에 부하를 준다.
- 첫 번째 응답을 캐시에 보관하여 다음에 오는 요청을에 대한 응답으로 사용할 수 있다.

### 대역폭 병목

- 캐시는 네트워크 병목을 줄여준다.
- 클라이언트들이 서버에 접근하는 속도는, 그 경로에 있는 가장 느린 네트워크의 속도와 같다.
- 만약, 클라이언트가 빠른 LAN에 있는 캐시로 부터 사본을 가져온다면, 캐싱은 성능을 대폭 개선할 수 있다.

### 갑작스런 요청 쇄도

- 캐싱은 갑작스런 사건으로 인해 트래픽이 몰리는 것에 대처하기에 굉장히 유용하다.

### 거리로 인한 지연

- 대역폭이 문제가 되지 않더라도 순수한 거리 자체가 문제가 될 수 있다.
- 빛의 속도 그 자체가 유의미한 지연을 유발한다.

## 적중 & 부적중

캐시 hit 와 비슷한 개념으로 보인다.

캐시에 요청이 도착했을 때, 만약 그에 대응하는 사본이 있다면 그를 이용해 요청이 처리될 수 있다. 이것을 `캐시 적중`이라고 부른다. 대응되는 사본이 없다면 원 서버로 전달되는데 이것을 `캐시 부적중`이라고 한다.

## 캐시 토폴로지

개인 전용 캐시

- 웹 브라우저는 개인 전용 캐시를 내장하고 있다.
- 자주 쓰이는 문서를 개인용 컴퓨터의 디스크와 메모리에 캐시해놓고, 사용자가 캐시 사이즈와 설정을 수정할 수 있도록 허용한다.

공용 프락시 캐시

- 공유된 프락시 서버
- 공용 캐시에는 여러 사용자가 접근하기 때문에, 불필요한 트래픽을 줄일 수 있다.

## 캐시 처리 단계

![Image.png](https://res.craft.do/user/full/8884c80f-6eec-6a29-2a03-049def967beb/doc/E7D57FF4-0D21-47C5-8F01-687FC836424E/E92E9009-70CE-49C2-A02E-8176E86D79DA_2/4o6QD92jxO0bEcJxwaPAbxxwbwCQSUnyzbYLtH0eCAkz/Image.png)

**HTTP GET 메시지 하나를 처리하는 기본적인 캐시 처리 절차 7단계**

1. 요청 받기 - 캐시는 네트워크로 부터 도착한 요청 메시지를 읽는다.
2. 파싱 - 캐시는 메시지를 파싱하여 URL과 헤더들을 추출한다.
3. 검색 - 캐시는 캐시는 로컬 복사본이 있는지 검사하고, 사본이 없다면 사본을 받아온다(그리고 로컬에 저장한다).
4. 신선도 검사 - 캐시는 캐시된 사본이 충분히 신선한지 검사하고, 신선하지 않다면 서버에게 변경사항이 있는지 물어본다.
5. 응답 생성 - 캐시는 새로운 헤더와 캐시된 본문으로 응답 메시지를 만든다.
6. 발송 - 캐시는 네트워크를 통해 응답을 클라이언트에게 돌려준다.
7. 로깅 - 선택적으로, 캐시는 로그파일에 트랜잭션에 대해 서술한 로그 하나를 남긴다.

## 캐시를 새로고침하는 시점

> 캐시된 데이터는 서버의 데이터와 일치하도록 관리되어야 한다.

### 문서 만료

- HTTP는 `Cache-Control`과 `Expires`라는 특별한 헤더들을 이용해서 원 서버가 각 무서에 유효기간을 붙일 수 있게 해준다.
- 캐시된 문서가 만료되면, 캐시는 반드시 서버와 문서에 변경된 것이 있는 검사해야 하며, 만약 그렇다면 신선한 사본을 얻어 와야 한다

| 헤더                     | 역할                                                 |
| ---------------------- | -------------------------------------------------- |
| Cache-Control: max-age | 문서의 최대 수명을 정의                                      |
| Expires                | 절대 유효기간을 명시한다. 만약 유효기간이 경과했다면, 그 문서는 더 이상 신선하지 않다. |

## 캐시 제어

no-cache와 no-store 응답 헤더

- no-store : 캐시가 그 응답의 사본을 만드는 것을 금지한다.
- no-cache : 로컬 캐시 저장소에 저장될 수 있다. 다만 먼저 서버와 재검사를 하지 않고서는

캐시에서 클라이언트로 제공될 수 없을 뿐이다.

