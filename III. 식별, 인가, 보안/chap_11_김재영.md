# chap 11 (클라이언트 식별과 쿠키)

**HTTP가 사용자를 식별하는 데 사용하는 기술들**

## HTTP 헤더

사용자에 대한 정보를 전달하는 가장 일반적인 일곱 가지 HTTP 요청 헤더

| **헤더 이름**       | **헤더 타입** | 용도                      |
| --------------- | --------- | ----------------------- |
| From            | 요청        | 사용자의 이메일 주소             |
| User-Agent      | 요청        | 사용자의 브라우저               |
| Referer         | 요청        | 사용자가 현재 링크를 타고 온 근원 페이지 |
| Authorization   | 요청        | 사용자 이름과 비밀번호            |
| Client-Ip       | 확장(요청)    | 클라이언트의 IP 주소            |
| X-Forwarded-For | 확장(요청)    | 클라이언트의 IP 주소            |
| Cookie          | 확장(요청)    | 서버가 생성한 ID 라벨           |

**From 헤더**

- 각 사용자의 이메일 주소로 사용자를 식별할 수 있지만, **악의적인 서버가 이메일을 모아서 스팸 메일을 발송하는 문제로 From 헤더를 보내는 브라우저는 많지 않다.**

**User-Agent 헤더**

- 사용자가 쓰고있는 브라우저의 이름과 버전 정보, 어떤 경우에는 운영체제에 대한 정보를 포함한다.
- 이는 특정 브라우저에서 제대로 동작하도록 그것들의 속성에 맞춰 콘텐츠를 최적화 하는데 유용할 수 있지만 사용자를 식별하는 데는 큰 도움이 되지 않는다.

**Referer 헤더**

- **사용자가 현재 페이지로 유입하게 한 웹페이지의 URL**을 가리킨다.
- Refere 헤더 자체만으로 사용자를 식별할 수 없지만 사용자가 전에 방문했던 페이지를 알 수 있다.

하지만 이 헤더들 만으로 사용자를 구분하기는 쉽지않다.

## 클라이언트 IP 주소

- 클라이언트의 IP 주소를 사용하는 방식은 사용자가 확실한 IP 주소를 갖고있고, IP는 좀처럼(혹은 절대) 바뀌지 않고, 웹 서버가 요청마다 클라이언트의 IP 주소를 알 수 있다면 문제없이 동작한다.

→ 문제없이 동작하기 어렵다는 말이 아닐까?

- 클라이언트의 IP 주소는 보통 HTTP 헤더에 없지만 웹 서버는 HTTP 요청을 보내는 TCP 커넥션의 반대쪽 IP를 알아낼 수 있다.

**클라이언트 IP 주소로 사용자를 식별하는 방법의 약점**

- 여러명이 한 컴퓨터를 이용할 경우 각각의 사용자를 식별할 수 없다.
- 많은 ISP는 사용자가 로그인하면 동적으로 IP를 할당한다.
- 웹 서버는 클라이언트의 IP 주소 대신 프락시의 IP 주소를 본다.

→  일부 프락시는 클라이언트의 IP 주소를 보존하기 위해 Client-Ip나 `X-Forward-For` HTTP 같은 헤더를 사용하지만 모든 프락시가 이런식으로 동작하진 않는다.

> **Routing : 라우팅**

- > 어떤 네트워크 안에서 통신 데이터를 보낼 최적의 경로를 선택하는 과정이다.
- > 최적의 경로는 최단 거리가 될 수도 있으며, 가장 빠른시간에 전달하는 것을 계산될 수도 있다.
- > 라우팅은 전화 통신망, 전자 정보 통신망(인터넷 등), 교통망 등 여러 종류의 네트워크에서 사용된다.
- > 인터넷상의 트래픽의 단위 전달을 의미하는 패킷의 전달이 효율적이며 효과적으로 최단거리 또는 최단 시간에 전달될 수 있도록 하는 것이다.
- > 일반적으로 라우터, 브릿지, 게이트웨이, 방화벽 또는 스위치로 불리는 중간 노드를 거쳐 출발지부터 최종 목적지까지 논리적으로 주소가 부여된 패킷의 전달 과정을 총괄하는 것이 라우팅이다.

> **Router : 라우터 (`라우팅` 기능을 갖는 공유기)**

- > 어떤 네트워크 안에서 통신 데이터를 보낼 최적의 경로를 선택하는 과정이다.
- > 최적의 경로는 최단 거리가 될 수도 있으며, 가장 빠른시간에 전달하는 것을 계산될 수도 있다.
- > 라우팅은 전화 통신망, 전자 정보 통신망(인터넷 등), 교통망 등 여러 종류의 네트워크에서 사용된다.
- > 인터넷상의 트래픽의 단위 전달을 의미하는 패킷의 전달이 효율적이며 효과적으로 최단거리 또는 최단 시간에 전달될 수 있도록 하는 것이다.
- > 일반적으로 라우터, 브릿지, 게이트웨이, 방화벽 또는 스위치로 불리는 중간 노드를 거쳐 출발지부터 최종 목적지까지 논리적으로 주소가 부여된 패킷의 전달 과정을 총괄하는 것이 라우팅이다.

## 뚱뚱한 URL

- 사용자의 상태 정보를 포함하고 있는 URL
- 각 URL은 웹 상점을 돌아다니는 사용자에게 할당된 식별번호(eg. 002-1145265-8016838)를 각 URL 뒤에 붙여서 사용자를 추적한다.
- 너무 긴 URL, 공유하지 못하는 URL, 캐시 사용 불가, 서버 부하 가중 등의 단점 때문에 현재에는 더이상 이 방법을 사용하지 않는다.

## 쿠키

- 쿠키는 사용자를 식별하고 세션을 유지하는 방식 중에서 현재까지 가장 널리 사용하는 방식
- 근래에는 JWT(Json Web Token)이라고 쿠키를 확용한 인증 방법이 가장 많이 사용된다.
- 캐시와 충돌할 수 있어서 쿠키에 있는 내용물은 캐싱하지 않는다.
- 쿠키는 넥스케이프가 최초로 개발했다.

### 쿠키의 타입

- 쿠키는 크게 세션 쿠키(session cookie)와 지속 쿠키(persistent cookie) 두 가지 타입으로 나눌 수 있다.
- 세션 쿠키의 경우 브라우저 창이 닫히면 사라지지만, 지속 쿠키는 컴퓨터를 재시작 하더라도 남는다.

### 쿠키의 동작 방식

- 쿠키는 '임의의 이름=값' 형태의 리스트를 가지고, 그 리스트는 Set-Cookie 혹은 Set-Cookie2(확장 헤더) 같은 HTTP 응답 헤더에 기술되어 전달한다.
- 예를 들어 서버는 id="34294"라는 쿠키를 사용자에게 할당하는데, 서버는 이 쿠키 값으로 데이터베이스에서 사용자의 정보(구매 내용, 주소 정보 등)를 찾는데 사용할 수 있다.

### 사이트마다 각기 다른 쿠키들

- 브라우저는 수천 개의 쿠키를 가지고 있을 수 있지만, 각 사이트에 두 개 혹은 세 개의 쿠키를 보낸다.
- 쿠키들의 대부분은 서버에 특화된 이름/값 쌍을 포함하고 있기 때문에, 대부분 사이트에서는 인식하지 않는 무의미한 값이다.

### 쿠키와 캐싱

- 캐시되지 말아야할 문서가 있다면 표시하라.
   - 만약 문서가 Set-Cookie 헤더를 제외하고 캐시를 해도 될 경우라면 그 문서에 명시적으로 Cache-Control: no-cache="Set-Cookie"를 기술해서 명확히 표시한다.
- Set-Cookie 헤더를 캐시 하는 것에 유의하라
   - 응답에 Set-Cookie 헤더를 가지고 있으면, 본문은 캐시할 수 있지만 Set-Cookie 헤더를 캐시하는 것은 주의가 필요하다.
   - 같은 Set-Cookie 헤더를 여러 사용자에게 보내면, 사용자 추적에 실패할 것이기 때문이다.

